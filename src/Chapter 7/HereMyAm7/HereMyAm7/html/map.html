<!DOCTYPE html>
<html>
    <head>
        <title>Map</title>
        <script type="text/javascript" src="http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0"></script>
        
        <script type="text/javascript">            
            //Global variables here
            var map = null;

            document.addEventListener("DOMContentLoaded", init);
            window.addEventListener("message", processMessage);

            //Function to turn a string in the syntax { functionName: ..., args: [...] }
            //into a call to the named function with those arguments. This constitutes a generic 
            //dispatcher that allows code in an iframe to be called through postMessage.
            function processMessage(msg) {
                //Verify data and origin (in this case the local context of the app)
                if (!msg.data || msg.origin !== "ms-appx://" + document.location.host) {
                    return;
                }

                var call = JSON.parse(msg.data);

                if (!call.functionName) {
                    throw "Message does not contain a valid function name.";
                }

                var target = this[call.functionName];

                if (typeof target != 'function') {
                    throw "The function name does not resolve to an actual function";
                }
                
                return target.apply(this, call.args);
            }


            function notifyParent(event, args) {
                if (typeof args == "undefined") {
                    args = {};
                }

                //Add event name to the arguments object and stringify as the message
                args["event"] = event;
                //Target origin is the local context of the app
                window.parent.postMessage(JSON.stringify(args), "ms-appx://" + document.location.host);
            }

            //Create a default map automatically (though the namespace won't be defined without connectivity
            function init() {                
                //If we don't have the Microsoft namespace, the script must have failed to load.
                //In this case we'll set the img.onclick handler to attempt to reload the iframe.
                //This way, if network connectivity happened to be restored, it should then work.
                //You can test this by disconnecting from the network, uninstalling the app (to clear
                //any cached map script), and running the app. It should hit this error case and show
                //the error image. Then reconnect the network and click the image; the map should reload
                //if it's able to get the script, otherwise it continues to come here.
                if (typeof Microsoft == "undefined") {
                    //Make sure the error is visible; we didn't want it to start off being visible.
                    var errorImage = document.getElementById("errorImage")
                    errorImage.style.display = "";
                    
                    errorImage.onclick = function () {
                        document.location.reload(true);
                    }

                    return;
                    }
                
                map = new Microsoft.Maps.Map(document.getElementById("mapDiv"), {
                        //NOTE: replace these credentials with your own obtained at
                        //http://msdn.microsoft.com/en-us/library/ff428642.aspx
                        credentials: "AlHJ5gHTINN2iD7HxLJpHn0e_tZYvzUAOsfqd37Rhj1NJz37vhUuE5iBAYJsH-ul",
                        //zoom: 12,
                        mapTypeId: Microsoft.Maps.MapTypeId.road
                    });

                if (map != null) {
                    //We created the map, so make sure the error image is hidden
                    document.getElementById("errorImage").style.display = "none";
                }
            }

            function pinLocation(lat, long) {
                if (map === null) {
                    //We used to throw here, but now we have a way to handle the error with the image
                    return;
                }

                var location = new Microsoft.Maps.Location(lat, long);                
                var pushpin = new Microsoft.Maps.Pushpin(location, { draggable: true });

                Microsoft.Maps.Events.addHandler(pushpin, "dragend", function (e) {
                    var location = e.entity.getLocation();
                    notifyParent("locationChanged", { latitude: location.latitude, longitude: location.longitude });
                });

                //Pop any previous pushpin, otherwise repeated calls will create new pins.
                map.entities.pop();

                //Add the new one
                map.entities.push(pushpin);
                map.setView({ center: location, zoom: 12, });                                
                return;
            }

            function setZoom(zoom) {
                if (map === null) {
                    //We used to throw here, but now we have a way to handle the error with the image
                }

                map.setView({ zoom: zoom });
            }
        </script>
    </head>
    <body>
        <div id="mapDiv">
            <!-- We'll show this element if we don't get the script loaded for the map -->
            <img id="errorImage" style="display: none; width: 100%; height: 100%;" src="maperror.png" />
        </div>
    </body>
</html>